- name: Check if repository exists
  stat:
    path: "{{ app_directory }}/.git"
  register: git_repo

- name: Clone application repository
  git:
    repo: "{{ app_repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ app_repo_branch }}"
    force: yes
  become_user: "{{ ansible_user }}"
  when: not git_repo.stat.exists
  register: git_clone

- name: Pull latest changes from repository
  git:
    repo: "{{ app_repo_url }}"
    dest: "{{ app_directory }}"
    version: "{{ app_repo_branch }}"
    update: yes
  become_user: "{{ ansible_user }}"
  when: git_repo.stat.exists
  register: git_pull

- name: Copy environment file from template
  template:
    src: env.j2
    dest: "{{ app_directory }}/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  register: env_file

- name: Copy Traefik configuration
  template:
    src: traefik.yml.j2
    dest: "{{ app_directory }}/traefik/traefik.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  register: traefik_config

- name: Copy Traefik dynamic configuration
  template:
    src: config.yml.j2
    dest: "{{ app_directory }}/traefik/config.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  register: traefik_dynamic_config

- name: Stop existing containers if configuration changed
  command: docker compose down
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ ansible_user }}"
  when: env_file.changed or traefik_config.changed or traefik_dynamic_config.changed or git_pull.changed or git_clone.changed
  ignore_errors: true

- name: Pull Docker images
  command: docker compose pull
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ ansible_user }}"
  register: docker_pull
  changed_when: "'Pulled' in docker_pull.stdout or 'Downloaded' in docker_pull.stdout"

- name: Build Docker images
  command: docker compose build --no-cache
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ ansible_user }}"
  when: git_pull.changed or git_clone.changed
  register: docker_build

- name: Start application services
  command: docker compose up -d
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ ansible_user }}"
  register: compose_up

- name: Wait for services to start
  wait_for:
    timeout: 60
  when: compose_up.changed

- name: Prune unused Docker images
  command: docker image prune -af
  become_user: "{{ ansible_user }}"
  when: docker_build.changed
  changed_when: true

- name: Get running containers
  command: docker compose ps
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ ansible_user }}"
  register: running_containers
  changed_when: false

- name: Display running containers
  debug:
    var: running_containers.stdout_lines

- name: Check Traefik logs for errors
  command: docker compose logs --tail=50 traefik
  args:
    chdir: "{{ app_directory }}"
  become_user: "{{ ansible_user }}"
  register: traefik_logs
  changed_when: false
  failed_when: false

- name: Display recent Traefik logs
  debug:
    var: traefik_logs.stdout_lines
  when: traefik_logs.rc == 0
